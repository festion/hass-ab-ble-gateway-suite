title: BLE Utility
path: ble-utility
icon: mdi:bluetooth
views:
  - title: BLE Utility
    path: main
    icon: mdi:bluetooth
    cards:
      - type: vertical-stack
        cards:
          # Header
          - type: markdown
            content: >
              # BLE Utility Dashboard
              
              Use this dashboard to discover, manage, and monitor Bluetooth Low Energy devices and gateways.
            
          # Tabs  
          - type: custom:layout-card
            layout_type: custom:grid-layout
            layout:
              grid-template-columns: 1fr
              grid-template-rows: auto
              grid-template-areas: |
                "tabs"
                "content"
            cards:
              # Tab selector
              - type: custom:mushroom-chips-card
                chips:
                  - type: template
                    icon: mdi:bluetooth-search
                    name: Discovery
                    tap_action:
                      action: navigate
                      navigation_path: /ble-utility/discovery
                      
                  - type: template
                    icon: mdi:format-list-bulleted
                    name: Managed Devices
                    tap_action:
                      action: navigate
                      navigation_path: /ble-utility/managed
                          
                  - type: template
                    icon: mdi:router-wireless
                    name: Gateway
                    tap_action:
                      action: navigate
                      navigation_path: /ble-utility/gateway
                alignment: center
                grid-area: tabs
                
  - title: Device Discovery
    path: discovery
    icon: mdi:bluetooth-search
    cards:
      - type: entities
        title: Device Discovery
        entities:
          - type: conditional
            conditions:
              - entity: input_button.bluetooth_scan
                state_not: "unavailable"
            row:
              entity: input_button.bluetooth_scan
              name: Scan for BLE Devices
              icon: mdi:bluetooth-search
          - type: conditional
            conditions:
              - entity: button.bluetooth_scan
                state_not: "unavailable"
              - entity: input_button.bluetooth_scan
                state: "unavailable"
            row:
              entity: button.bluetooth_scan
              name: Scan for BLE Devices
              icon: mdi:bluetooth-search
          - type: conditional
            conditions:
              - entity: script.bluetooth_scan
                state_not: "unavailable"
              - entity: button.bluetooth_scan
                state: "unavailable"
              - entity: input_button.bluetooth_scan
                state: "unavailable"
            row:
              entity: script.bluetooth_scan
              name: Scan for BLE Devices
              icon: mdi:bluetooth-search
          - entity: input_text.discovered_ble_devices
            name: Discovered Devices (JSON)
          - type: divider
          - type: section
            label: Detected BLE Devices
          - type: markdown
            content: >
              {% set device_json = states('input_text.discovered_ble_devices') %}
              {% set devices = device_json | from_json %}
              {% set device_map = state_attr('sensor.ble_gateway_raw_data', 'device_map') or {} %}
              
              {% if devices|length > 0 %}
                ### Discovered Devices
                
                | Device | MAC | RSSI | Select |
                | ------ | --- | ---- | ------ |
                {% for mac, rssi in devices.items() %}
                | {{ device_map[mac|replace(':', '')] if mac|replace(':', '') in device_map else mac }} | {{ mac }} | {{ rssi }} dBm | [Select](###) |
                {% endfor %}
              {% else %}
                ### No Devices Discovered
                Press "Scan for BLE Devices" to search for nearby Bluetooth devices.
              {% endif %}
          - type: button
            name: Scan and List Devices
            icon: mdi:refresh
            tap_action:
              action: call-service
              service: script.scan_and_display_ble_devices
          - type: divider
          - type: section
            label: Selected Device
          - entity: input_text.selected_ble_device
            name: Selected Device MAC
          - entity: input_text.ble_device_name
            name: Device Name
          - entity: input_select.ble_device_type
            name: Device Type
          - entity: input_number.ble_rssi_threshold
            name: RSSI Threshold
          - entity: input_text.ble_device_icon
            name: Icon (MDI name)
          - type: button
            name: Add Selected Device
            icon: mdi:plus-circle
            tap_action:
              action: call-service
              service: script.add_ble_device
              service_data:
                device_name: "{{ states('input_text.ble_device_name') }}"
                mac_address: "{{ states('input_text.selected_ble_device') }}"
                device_type: "{{ states('input_select.ble_device_type') }}"
                rssi_threshold: "{{ states('input_number.ble_rssi_threshold') | int }}"
                icon: "{{ states('input_text.ble_device_icon') }}"
          - type: button
            name: Run Signal Test
            icon: mdi:signal
            tap_action:
              action: call-service
              service: script.test_ble_signal
              service_data:
                mac_address: "{{ states('input_text.selected_ble_device') }}"
                test_duration: 30
  
  - title: Managed Devices
    path: managed
    icon: mdi:format-list-bulleted
    cards:
      - type: entities
        title: Managed BLE Devices
        entities:
          - entity: sensor.ble_gateway_raw_data
            name: BLE Gateway Status
            secondary_info: "{{ state_attr('sensor.ble_gateway_raw_data', 'gateway_id') or 'Unknown' }}"
          - type: conditional
            conditions:
              - entity: input_text.discovered_ble_devices
                state_not: "{}"
            row:
              entity: script.scan_and_display_ble_devices
              name: Refresh Device List
              icon: mdi:refresh
          
  - title: Gateway Management
    path: gateway
    icon: mdi:router-wireless
    cards:
      - type: entities
        title: BLE Gateway Management
        entities:
          - entity: sensor.ble_gateway_raw_data
            name: Gateway Status
            secondary_info: "{{ state_attr('sensor.ble_gateway_raw_data', 'gateway_id') or 'Unknown' }}"
          - type: divider
          - type: section
            label: Actions
          - type: button
            name: Safe Reconnect
            icon: mdi:connection
            tap_action:
              action: call-service
              service: ab_ble_gateway.mqtt_reconnect
              target: {}
              data: {}
          - type: button
            name: Show Logs
            icon: mdi:text-box-outline
            tap_action:
              action: navigate
              navigation_path: /config/logs